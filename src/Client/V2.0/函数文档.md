# 函数使用文档

## mySpi 类

该类是用于自定义 spi ，是基于 **MaixPy** 进行修改封装，其文件为 **myWiznet5k_spi.py**

> **注：使用过程中需要将该文件保存在开发板**



### 一、构造函数

```python
from myWiznet5k_spi as *	# 导入模块
from machine import SPI		# 导入SPI模块

spi = mySpi(SPI.SPI1)
```

通过使用 **SPI** 类中的常量对 **mySpi** 进行传参，构造了一个 spi 的调用对象



### 二、方法

#### 2.1 init

- 函数原型

  ```python
  __init__(self, id, baudrate=10000000, sck=28, mosi=29, miso=30, cs=27)
  ```

  - mySpi 的初始化函数
  - 参数：
    - `id`: **必传参数**。 SPI ID，取值范围[0,4]，目前只支持 0 和 1 、4 ，并且只能是主机模式，2 只能作为从机，目前未实现，3 保留, 4 使用软模拟 SPI（.SPI_SOFT）
    - `baudrate`: SPI 波特率，**默认为 10MHz**
    - `sck`: SCK（时钟）引脚， 可直接传引脚数值，取值范围：[0,47]。 可以不设置，而是使用 [fm](https://wiki.sipeed.com/soft/maixpy/zh/api_reference/builtin_py/fm.html) 统一管理引脚映射。**默认为 28 脚**
    - `mosi`: MOSI（主机输出） 引脚， 可直接传引脚数值，取值范围：[0,47]。 可以不设置，而是使用 [fm](https://wiki.sipeed.com/soft/maixpy/zh/api_reference/builtin_py/fm.html) 统一管理引脚映射。**默认为 29 脚**
    - `miso`: MISO（主机输入） 引脚， 可直接传引脚数值，取值范围：[0,47]。 可以不设置，而是使用 [fm](https://wiki.sipeed.com/soft/maixpy/zh/api_reference/builtin_py/fm.html) 统一管理引脚映射。**默认为 30 脚**
    - `cs`: CS（片选） 引脚， 可直接传引脚数值，取值范围：[0,47]。 可以不设置，而是使用 [fm](https://wiki.sipeed.com/soft/maixpy/zh/api_reference/builtin_py/fm.html) 统一管理引脚映射。**默认为 27 脚**
  - 返回值：
    - mySpi 对象
  - 其他信息：
    - 默认采用 **SPI.MODE_MASTER** 主机模式，spi **空闲时 低电平，在第一个跳变沿采样**，数据宽度 **8 位**



#### 2.2 wiz_writeBuff

- 函数原型

  ```python
  spi.wiz_writeBuff(addr, buf)
  ```

  - 通过 spi 向 addr（地址）发送 buf（数组）
  - 参数：
    - `addr`: spi发送的地址参数
    - `buf`: spi发送的数组参数，其类型为 `bytearray `，数组可任意长度，**但不能为0**
  - 返回值：
    - None



#### 2.3 wiz_readBuff

- 函数原型

  ```python
  bytesBuf = spi.wiz_readBuff(addr, length)
  ```

  - 通过 spi 读取 addr 中的 length 长个数据
  - 参数：
    - `addr`: spi发送的地址参数
    - `length`: 接收几个数据
  - 返回值：
    - 以 `bytearray(length) ` 的对象



#### 2.4 IINCHIP_WRITE

- 函数原型

  ```python
  spi.IINCHIP_WRITE(addr, data)
  ```

  - 通过 spi 向 addr 写入一个字节数据
  - 参数：
    - `addr`: spi发送的地址参数
    - `data`: 写入的数据, **为一个字节数据**、
  - 返回值：
    - None



#### 2.5 IINCHIP_READ

- 函数原型

  ```python
  data = spi.IINCHIP_READ(addr)
  ```

  - 通过 spi 从 addr 中读出 一个字节数据
  - 参数：
    - `addr`: spi发送的地址参数
  - 返回值：
    - int 型一个字节数据



### 三、常量

- `spi.cs`: cs 脚对象
- `spi.spi`: 构造的 spi 对象



### 四、示例

- 初始化 mySpi 以及使用

  ```python
  import myWiznet5k_spi as wiznet5k_spi
  from machine import SPI
  
  # 如果需要传入 SPI.SPI1 形式的参数，就需要引入 SPI 类
  spi = wiznet5k_spi.mySpi(SPI.SPI1)
  '''
  也可使用以下方法：(此时就不需要 from machine import SPI)
  spi = wiznet5k_spi.mySpi(1)
  '''
  
  spi.wiz_writeBuff(0x00, bytearray([255, 255, 255, 0]))	# 发送 buf
  dateBuf = spi.wiz_readBuff(0x00, 4)	# 从 0x00 读 4 个字节数据
  print(dateBuf)
  spi.IINCHIP_WRITE(0x01, 0x02)	# 向 0x01 中写入 0x02
  date = spi.IINCHIP_READ(0x01)	# 从 0x01 中读取一字节数据
  print(date)
  ```

---





## myWinznet5k 类

该类用于存放 W5500 的相关寄存器配置以及其他设置寄存器的函数配置，其文件为 **myWiznet5k.py**

> **注：使用过程中需要将该文件保存在开发板**



### 一、构造函数

```python
form myWiznet5k import *	# 导入模块

# 需要配置 mySpi 类使用，将构造的 spi 对象进行传入
wiznet5k = myWinznet5k(spi, config=config, reset_pin=reset)
```

构造了一个 w5500 的对象，其中 reset_pin 需要传入自定义的复位引脚，默认情况下会进行自动复位。而 config 中保存的是：mac、ip、网关以及子网掩码信息。



### 二、方法

#### 2.1 init

- 函数原型

  ```python 
  __init__(self, spi_port, config=None, reset_pin=None, mac=None, local_ip=None, subnet=None, gateway=None, is_reset=True, is_debug=False)
  ```

  - 构造一个 myWinznet5k 对象
  - 参数：
    - `spi_port`: **必要参数**，传入已经初始化好的 [spi](#mySpi 类) 对象
    - `config`: 配置信息，类型需为 **元组**，如（(mac), (local_ip), (subnet), (gateway)），**传入此参数时，就无需传入 `mac`、`local_ip`、`subnet`以及`gateway`，同时需要 `is_reset` 为 `True` 时才能正确配置信息**
    - `reset_pin`: 复位引脚对象，需要进行构造、映射，具体可以查看 [fpioa_manager](https://wiki.sipeed.com/soft/maixpy/zh/api_reference/builtin_py/fm.html) 以及 [GPIO](https://wiki.sipeed.com/soft/maixpy/zh/api_reference/Maix/gpio.html)，当 `is_reset` 参数为 `False` 时可以不传入，但当 `is_reset` 为 `True` 时，必须要传入此参数
    - `mac`: 本机 mac 地址，需要以 `bytearray` 对象进行传入，**传入此参数时，就无需传入 `config`，同时需要 `is_reset` 为 `True` 时才能正确配置信息**
    - `local_ip`: 本机 ip 地址，需要以 `bytearray` 对象进行传入，**传入此参数时，就无需传入 `config`，同时需要 `is_reset` 为 `True` 时才能正确配置信息**
    - `subnet`: 本机子网掩码，需要以 `bytearray` 对象进行传入，**传入此参数时，就无需传入 `config`，同时需要 `is_reset` 为 `True` 时才能正确配置信息**
    - `gateway`: 本机网关，需要以 `bytearray` 对象进行传入，**传入此参数时，就无需传入 `config`，同时需要 `is_reset` 为 `True` 时才能正确配置信息**
    - `is_reset`: 是否进行复位，为 `True` 时才能进行信息配置，**默认开启**
    - `is_debug`: 是否开启提示信息打印，**默认不开启**
  - 返回值：
    - myWinznet5k 对象



#### 2.2 reset_w5500

- 函数原型

  ```python
  wiznet5k.reset_w5500()
  ```

  - 软件复位 
  - 参数：
    - None
  - 返回值：
    - None



#### 2.3 set_mac

- 函数原型

  ```python
  wiznet5k.set_mac(mac)
  ```

  - 设置 mac 地址，如果不传入的话，采用默认的初始化的参数，如果传入则使用传入的参数
  - 参数：
    - `mac`: mac 地址参数，需要以 `bytearray` 对象进行传入
  - 返回值：
    - None



#### 2.4 set_ip

- 函数原型

  ```python
  wiznet5k.set_ip(local_ip， subnet， gateway)
  ```

  - 设置 IP 信息，包括: IP 地址、子网掩码、网关。同样的如果不传入的话，采用默认的初始化的参数，如果传入则使用传入的参数。
  - 参数：
    - `local_ip`: 本机 ip 地址，需要以 `bytearray` 对象进行传入
    - `subnet`: 本机子网掩码，需要以 `bytearray` 对象进行传入
    - `gateway`: 本机网关，需要以 `bytearray` 对象进行传入
  - 返回值：
    - None



#### 2.5 get_ip

- 函数原型

  ```python
  wiznet5k.get_ip(str)
  ```

  - 获取设置 IP 信息，包括: IP 地址、子网掩码、网关。
  - 参数：
    - `str`: 如果不传入的话，采用默认的初始化的参数，如果传入则使用传入的参数。传入的参数为本对象的常量：`wiznet5k.local_ip`、`wiznet5k.subnet`、`wiznet5k.gateway`。分别用于获取：ip、子网掩码、网关
  - 返回值：
    - 始终为获取到的 ip 地址，其为 `bytearray` 对象



#### 2.6 socketBuf_Init

- 函数原型

  ```python
  wiznet5k.socketBuf_Init()
  ```

  - 设置发送、接收缓冲区大小
  - 参数：
    - None
  - 返回值：
    - None



### 三、常量

其中包含众多寄存器，以及参数，寄存器就不再进行赘述，那是因为实在太多了，自行查看源码就好

- `wiznet5k.mac`: 传入的 mac 地址
- `wiznet5k.local_ip`: 传入的 ip 地址
- `wiznet5k.subnet`: 传入的子网掩码
- `wiznet5k.gateway`: 传入的网关

- `wiznet5k.MAX_SOCK_NUM`: SOCK 最大数量
- `wiznet5k.MAX_SOCK_SIZE`: SOCK 最大容纳数据量
- `wiznet5k.SSIZE`: 发送缓冲区最大大小
- `wiznet5k.RSIZE`: 接收缓冲区最大大小
- `wiznet5k.txsize`: 发送缓冲区最大 bit
- `wiznet5k.rxsize`: 接收缓冲区最大 bit



### 四、示例

- 基础使用示例

  ```python
  import myWiznet5k_spi as wiznet5k_spi
  import myWiznet5k as wiznet5k
  from machine import SPI
  from fpioa_manager import fm
  from Maix import GPIO
  import time
  
  # 配置信息
  config = (
      bytearray([0x00, 0x08, 0xdc, 0x11, 0x11, 0x11]),  # mac 地址
      bytearray([255, 255, 255, 0]),  # 子网掩码
      bytearray([192, 168, 5, 1]),  # 网关
      bytearray([192, 168, 5, 5])  # ip地址
  )
  
  # reset 脚
  fm.register(31, fm.fpioa.GPIOHS11, force=True)  # reset
  reset = GPIO(GPIO.GPIOHS11, GPIO.OUT)  # reset 脚
  reset.value(1)
  
  # 初始化 mySpi 类
  spi = wiznet5k_spi.mySpi(SPI.SPI1)
  
  # 延时，等待稳定
  for i in range(1, 11):
      print(wiznet5k_spi.debugStr + 'wait for start ....... have {} second!'.format(10-i))
      time.sleep_ms(1000)
  
  # w5500 初始化
  w5500 = wiznet5k.myWinznet5k(spi, reset_pin=reset, is_debug=True)
  
  while True:
      pass
  ```

  